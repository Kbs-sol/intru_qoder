---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { getAllOrders } from '@/lib/db';
import { formatPrice } from '@/lib/utils';

const db = Astro.locals.runtime.env.DB;
let orders: Awaited<ReturnType<typeof getAllOrders>> = [];

try {
  orders = await getAllOrders(db);
} catch {
  // DB not connected
}

const statusColors: Record<string, string> = {
  pending: 'bg-yellow-50 text-yellow-600',
  paid: 'bg-green-50 text-green-600',
  shipped: 'bg-blue-50 text-blue-600',
  delivered: 'bg-purple-50 text-purple-600',
  failed: 'bg-red-50 text-red-600',
};
---

<AdminLayout title="Orders | Admin" activeTab="orders">
  <h1 class="text-2xl font-bold mb-8">Orders</h1>

  <div class="bg-white rounded-lg border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-100">
            <th class="text-left p-4 text-xs font-bold uppercase tracking-wider text-gray-400">Order ID</th>
            <th class="text-left p-4 text-xs font-bold uppercase tracking-wider text-gray-400">Customer</th>
            <th class="text-left p-4 text-xs font-bold uppercase tracking-wider text-gray-400">Total</th>
            <th class="text-left p-4 text-xs font-bold uppercase tracking-wider text-gray-400">Status</th>
            <th class="text-left p-4 text-xs font-bold uppercase tracking-wider text-gray-400">Date</th>
            <th class="text-right p-4 text-xs font-bold uppercase tracking-wider text-gray-400">Action</th>
          </tr>
        </thead>
        <tbody>
          {orders.map(order => (
            <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
              <td class="p-4 text-sm font-mono">{order.id.slice(0, 8)}...</td>
              <td class="p-4">
                <p class="text-sm font-medium">{order.customer_name || 'Unknown'}</p>
                <p class="text-xs text-gray-400">{order.customer_email || ''}</p>
              </td>
              <td class="p-4 text-sm font-bold">{formatPrice(order.total_amount)}</td>
              <td class="p-4">
                <span class:list={['text-xs font-medium px-2 py-1 rounded capitalize', statusColors[order.status] || 'bg-gray-50 text-gray-600']}>
                  {order.status}
                </span>
              </td>
              <td class="p-4 text-xs text-gray-500">{new Date(order.created_at).toLocaleDateString()}</td>
              <td class="p-4 text-right">
                <select
                  x-data
                  @change={`fetch('/api/admin/orders', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id: '${order.id}', status: $event.target.value }) }).then(() => window.location.reload())`}
                  class="text-xs border border-gray-200 px-2 py-1 rounded"
                >
                  {['pending', 'paid', 'shipped', 'delivered'].map(s => (
                    <option value={s} selected={order.status === s}>{s}</option>
                  ))}
                </select>
              </td>
            </tr>
          ))}
          {orders.length === 0 && (
            <tr>
              <td colspan="6" class="p-8 text-center text-gray-400 text-sm">No orders yet.</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>
