---
import { getSession } from '@/lib/auth';

// If already logged in as admin, redirect to dashboard
const session = await getSession(Astro.request, Astro.locals.runtime.env.AUTH_SECRET);
if (session?.role === 'admin') {
  return Astro.redirect('/admin');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Login | intru</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="antialiased bg-gray-50 text-gray-900 flex items-center justify-center min-h-screen" style="font-family: 'Inter', sans-serif;">
  <div class="w-full max-w-sm mx-auto p-8" x-data="{ password: '', loading: false, error: '' }">
    <div class="text-center mb-8">
      <a href="/" class="font-black text-3xl tracking-tighter" style="font-family: 'Outfit', sans-serif;">intru</a>
      <p class="text-xs text-gray-400 mt-2">Admin Panel</p>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-100">
      <h1 class="text-lg font-bold mb-6">Admin Login</h1>

      <template x-if="error">
        <div class="bg-red-50 text-red-600 text-xs font-medium p-3 rounded mb-4" x-text="error"></div>
      </template>

      <form @submit.prevent="
        loading = true; error = '';
        fetch('/api/admin/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password }) })
        .then(r => r.json())
        .then(d => { if (d.error) { error = d.error; loading = false; } else { window.location.href = '/admin'; } })
        .catch(() => { error = 'Something went wrong'; loading = false; })
      ">
        <div class="mb-4">
          <label class="text-xs font-medium text-gray-500 block mb-2">Password</label>
          <input x-model="password" type="password" required class="w-full border border-gray-200 px-4 py-3 text-sm outline-none focus:border-black transition-colors rounded" placeholder="Enter admin password" />
        </div>
        <button type="submit" :disabled="loading" class="w-full bg-black text-white py-3 text-xs font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors disabled:opacity-50 cursor-pointer rounded">
          <span x-show="!loading">Sign In</span>
          <span x-show="loading" x-cloak>Signing in...</span>
        </button>
      </form>
    </div>
    <p class="text-center text-xs text-gray-300 mt-6"><a href="/" class="hover:text-gray-500">&larr; Back to store</a></p>
  </div>

  <style is:global>
    @import '../../styles/global.css';
    [x-cloak] { display: none !important; }
  </style>
</body>
</html>
